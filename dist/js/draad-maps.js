(()=>{var S=class{constructor(e){this.rootEl=e}rootEl=null;_active=!1;firstFocusableElement=null;lastFocusableElement=null;get active(){return this._active}set active(e){typeof e=="boolean"&&(this._active=e,this._active?this.activate():this.deactivate())}activate(){if(!this._active)return;let e=Array.from(this.rootEl.querySelectorAll("a[href], button, textarea, input, select, summary, [tabindex]"));if(e.filter(s=>s.getAttribute("tabindex")!=="-1"),e.length===0)return;let t=e.filter(s=>s.offsetParent!==null);this.firstFocusableElement=t[0],this.lastFocusableElement=t[t.length-1],this.rootEl.addEventListener("keydown",s=>{s.key==="Tab"&&(!s.shiftKey&&document.activeElement===this.lastFocusableElement?(s.preventDefault(),this.firstFocusableElement.focus()):s.shiftKey&&document.activeElement===this.firstFocusableElement&&(s.preventDefault(),this.lastFocusableElement.focus()))})}deactivate(){this.rootEl.removeEventListener("keydown",()=>{}),this.firstFocusableElement=null,this.lastFocusableElement=null}},_=S;var C={},x=new Event("draadMapsLoaded");function $(){C.maps=[],document.querySelectorAll(".draad-maps").forEach(e=>{let t=new M(e);C.maps.push(t),document.dispatchEvent(x)})}document.addEventListener("DOMContentLoaded",$);var M=class{node=null;map=null;center=null;zoom=null;outerWrapper=null;layers={};colors={};constructor(e){if(!e)throw new Error("Draad Maps: No map node provided.");this.mapNode=e,this.outerWrapper=e.closest(".draad-maps__wrapper"),this.map=this.createMap();let t=getComputedStyle(document.documentElement);this.colors={primary:t.getPropertyValue("--dk__clr-primary")||"#248641",secondary:t.getPropertyValue("--dk__clr-secondary")||"#7D6200",accent:t.getPropertyValue("--dk__clr-accent")||"#1261A3"},this.cluster=L.markerClusterGroup({showCoverageOnHover:!1,iconCreateFunction:i=>{let d=i.getChildCount(),h=" marker-cluster-large",c=56;return d<10?(h="marker-cluster-small",c=40):d<100&&(h+="marker-cluster-medium",c=48),new L.DivIcon({html:'<div class="marker-cluster"><span>'+d+' <span aria-label="markers"></span></span></div>',className:h,iconSize:new L.Point(c,c)})}});let s=this.outerWrapper.querySelectorAll(".draad-card--infowindow"),a=L.layerGroup(),r=0;s?.forEach(i=>{let d=i.offsetHeight;d>r&&(r=d),this.addMarker(i).addTo(a)}),this.layers.locations=a,this.layers.locations.addTo(this.cluster);let p=parseInt(getComputedStyle(document.documentElement).fontSize);if(e.style.minHeight=Math.round(r/p)+3+"rem",this.outerWrapper.addEventListener("keypress",i=>{i.key==="Enter"&&(h=>{let c=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});h.dispatchEvent(c)})(i.target)}),document.getElementById(e.id+"-gps")){let h=function(c){console.warn(`ERROR(${c.code}): ${c.message}`)},i={enableHighAccuracy:!0,timeout:5e3,maximumAge:0},d=c=>{let y=c.coords,g=L.layerGroup();L.marker([parseFloat(y.latitude),parseFloat(y.longitude)],{icon:this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-gps.png`,iconSize:[48,48],iconAnchor:[24,24]}),riseOnHover:!1,alt:"Your location"}).addTo(g),this.layers.userLocation=g,this.layers.userLocation.addTo(this.cluster)};navigator.geolocation.getCurrentPosition(d,h,i)}let o=this.outerWrapper.querySelectorAll(".draad-maps__dataset");o.length&&(o.forEach(i=>{let d=i.dataset.draadGeojson,h=i.dataset.datasetName;if(document.getElementById(i.dataset.draadGeojsonTarget)){let c=JSON.parse(document.getElementById(i.dataset.draadGeojsonTarget).text);this.loadGeoJson(c,h,i);return}else d&&fetch(d).then(c=>c.json()).then(c=>{this.loadGeoJson(c,h,i)})}),this.legendNode=this.outerWrapper.querySelector(".draad-maps__legend"),this.legendNode&&this.legendHandler()),this.map.addLayer(this.cluster);let u=this.outerWrapper.querySelector(".draad-search");u&&(this.searchInput=u.querySelector(".draad-search__input"),this.searchSubmit=u.querySelector(".draad-search__submit"),this.searchHandler());let m=this.outerWrapper.querySelector(".draad-maps__instructions");m&&(m.addEventListener("click",()=>m.remove()),m.addEventListener("touchstart",()=>m.remove()))}getLeafletIcon=e=>L.icon({iconUrl:"",iconSize:[39.2,51.2],iconAnchor:[19.6,51.2],popupAnchor:[-3,-76],...e});isRdCoordinates=(e,t)=>typeof e!="number"||typeof t!="number"?(console.error("Draad_Map.isRdCoordinates(): coordinates not valid",e,t),!1):e>0&&e<3e5&&t>3e5&&t<62e4;rdToWgs84=(e,t)=>{if(typeof e!="number"||typeof t!="number")return console.error("Draad_Map.rdToWgs84(): coordinates not valid"),!1;e<1e3&&(e*=1e3),t<1e3&&(t*=1e3);let s=155e3,a=463e3,r=52.156160556,p=5.387638889,o=3236.0331637,u=5261.3028966,m=-32.5915821,i=105.9780241,d=-.2472814,h=2.4576469,c=-.8501341,y=-.8192156,g=-.0655238,E=-.0560092,I=-.0171137,T=.0560089,A=.0052771,H=-.0025614,F=-3859e-7,N=.001277,D=3314e-7,G=2574e-7,j=371e-7,q=-973e-7,P=143e-7,O=293e-7,W=-9e-6,z=291e-7,n=(e-s)*Math.pow(10,-5),l=(t-a)*Math.pow(10,-5),v=o*l+m*Math.pow(n,2)+d*Math.pow(l,2)+c*Math.pow(n,2)*l+g*Math.pow(l,3);v+=A*Math.pow(n,4)+I*Math.pow(n,2)*Math.pow(l,2)+j*Math.pow(l,4)+D*Math.pow(n,4)*l,v+=F*Math.pow(n,2)*Math.pow(l,3)+P*Math.pow(n,4)*Math.pow(l,2)+W*Math.pow(n,2)*Math.pow(l,4);let b=r+v/3600,w=u*n+i*n*l+y*Math.pow(n,3)+h*n*Math.pow(l,2)+E*Math.pow(n,3)*l;w+=T*n*Math.pow(l,3)+G*Math.pow(n,5)+H*Math.pow(n,3)*Math.pow(l,2)+N*n*Math.pow(l,4),w+=O*Math.pow(n,5)*l+q*Math.pow(n,3)*Math.pow(l,3)+z*n*Math.pow(l,5);let k=p+w/3600,B=b+(-96.862-11.714*(b-52)-.125*(k-5))/1e5,U=k+(-37.902+.329*(b-52)-14.667*(k-5))/1e5;return{lat:B,lon:U}};loadGeoJson=(e,t,s)=>{if(typeof e.type>"u"||e.type!=="FeatureCollection"){if(typeof e.result.records!="object"){console.warn("Could not find records in dataset, The dataset my be unvalid.");return}e=this.jsonToGeoJSON(e.result.records)}typeof e.crs>"u"?console.warn("Could not determine EPSG code for the GeoJSON. The coordinates may be unvalid."):e.crs.type==="name"&&e.crs.properties.name==="EPSG:28992"&&(e=this.convertCoordinates(e)),delete e.crs;let a=this.addData(e,s);this.layers[t]=a,this.layers[t].addTo(this.cluster)};convertCoordinates=e=>{if(e.type==="FeatureCollection")return e.features.forEach(r=>{this.convertCoordinates(r)}),e.crs.properties.name="EPSG:4326",e;let t,s,a;switch(e.geometry.type){case"Point":t=e.geometry.coordinates[0],s=e.geometry.coordinates[1],this.isRdCoordinates(t,s)&&(a=this.rdToWgs84(t,s),e.geometry.coordinates=[a.lon,a.lat]);break;case"MultiPoint":e.geometry.type="Point",t=e.geometry.coordinates[0],s=e.geometry.coordinates[1],this.isRdCoordinates(t,s)&&(a=this.rdToWgs84(t,s),e.geometry.coordinates=[a.lon,a.lat]);break;case"Polygon":e.geometry.coordinates=[e.geometry.coordinates[0].map(r=>{if(typeof r[0]=="object"?(t=r[0][0],s=r[0][1]):(t=r[0],s=r[1]),this.isRdCoordinates(t,s))return a=this.rdToWgs84(t,s),[a.lon,a.lat]})];break;case"MultiPolygon":e.geometry.type="Polygon",e.geometry.coordinates=[e.geometry.coordinates.map(r=>{if(t=r[0],s=r[1],this.isRdCoordinates(t,s))return a=this.rdToWgs84(t,s),[a.lon,a.lat]})];break}return e};jsonToGeoJSON=e=>{let t={type:"FeatureCollection",features:[]};return e.forEach(s=>{if(typeof s.wkb_geometry>"u")return;let a,r=s.wkb_geometry.type;switch(r){case"MultiPoint":a=s.wkb_geometry.coordinates[0];break;case"MultiPolygon":a=s.wkb_geometry.coordinates[0][0];break;default:a=s.wkb_geometry.coordinates;break}(typeof t.crs>"u"||typeof t.crs.properties.name>"u")&&(t.crs={type:"name",properties:{name:s.wkb_geometry.crs.properties.name||null}}),delete s.wkb_geometry;let p={type:"Feature",properties:s.properties||s,geometry:{type:r,coordinates:a}};t.features.push(p)}),t};createMap=()=>{let e=this.mapNode.dataset.draadCenter.split("/");this.center=[parseFloat(e[1]),parseFloat(e[2])],this.zoom=parseInt(e[0]);let t=L.map(this.mapNode.id,{dragging:!L.Browser.mobile,tap:!L.Browser.mobile,scrollWheelZoom:!1}).setView(this.center,this.zoom);return L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(t),t.removeControl(t.zoomControl),L.control.zoom({position:"bottomleft",zoomInText:'<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><g><path d="M10 4.16602V15.8327" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.16602 10H15.8327" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g></svg>',zoomInTitle:"Zoom in",zoomOutText:'<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><g><path d="M4.16602 10H15.8327" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g></svg>',zoomOutTitle:"Zoom out"}).addTo(t),t};addMarker=e=>{let t=e.dataset.draadCenter.split("/").map(parseFloat),s=L.marker(t,{riseOnHover:!0,alt:e.querySelector(".draad-card__title")?.textContent});return s._styles={default:e.dataset.marker!==""?this.getLeafletIcon({iconUrl:e.dataset.marker}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker.png`}),hover:e.dataset.markerHover!==""?this.getLeafletIcon({iconUrl:e.dataset.markerHover}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-hover.png`}),active:e.dataset.markerActive!==""?this.getLeafletIcon({iconUrl:e.dataset.markerActive}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-active.png`})},s.setIcon(s._styles.default),s.selected=!1,s.locationTrap=new _(e),this.markerHandler(s,e),s};markerHandler=(e,t=null)=>{let s=this,a=t?t.querySelector(".draad-card__close"):null;a&&a.addEventListener("click",r=>{e.locationTrap.active=!1,this.markerSetState(e,"default"),e.selected=!1,e.icon&&e.icon.focus(),t.classList.remove("draad-infowindow--active"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden","")}),e.on("click",r=>{if(t&&t.querySelector(".draad-card__content")?.textContent)t.closest(".draad-maps__wrapper").querySelectorAll(".draad-card--infowindow").forEach(o=>{o.classList.remove("draad-card--active"),o.setAttribute("aria-hidden","true"),o.setAttribute("hidden","")}),this.layers.locations.eachLayer(o=>{o.selected===!0&&(this.markerSetState(o,"default"),o.selected=!1)}),e.selected===!0?(e.locationTrap.active=!1,t.classList.remove("draad-card--active"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden",""),e.icon&&e.icon.focus()):(t.classList.add("draad-card--active"),t.setAttribute("aria-hidden","false"),t.removeAttribute("hidden"),e.locationTrap.active=!0,t.querySelector(".draad-card__close").focus());else{for(let p in this.layers)this.layers[p].eachLayer(o=>{typeof o.setIcon=="function"?this.markerSetState(o,"default"):typeof o.setStyle=="function"&&o.setStyle(o._style),o.selected=!1,o.closePopup()});e.openPopup()}this.map.panTo(e.getLatLng()),typeof e.options.title<"u"&&(this.markerSetState(e,e.selected?"default":"active"),e.selected=!e.selected)}),e.on("popupclose",r=>{this.markerSetState(e,"default"),e.selected=!1,t&&(e.locationTrap.active=!1,t.classList.remove("draad-card--active"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden",""),e.icon&&e.icon.focus())})};markerSetState=(e,t)=>{switch(t){case"active":case"focus":e.setIcon(e._styles.active);break;case"hover":e.setIcon(e._styles.hover);break;default:e.setIcon(e._styles.default);break}};addData=(e,t)=>{let s=L.geoJSON(e);return s.getLayers()?.forEach(a=>{a._styles={default:typeof t<"u"&&t.dataset.marker!==""?this.getLeafletIcon({iconUrl:t.dataset.marker}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker.png`}),hover:typeof t<"u"&&t.dataset.markerHover!==""?this.getLeafletIcon({iconUrl:t.dataset.markerHover}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-hover.png`}),active:typeof t<"u"&&t.dataset.markerActive!==""?this.getLeafletIcon({iconUrl:t.dataset.markerActive}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-active.png`})},a._style={color:typeof t<"u"&&t.dataset.shapeColor!==""?t.dataset.shapeColor:this.colors.primary,weight:typeof t<"u"&&t.dataset.shapeWidth!==""?t.dataset.shapeWidth:4,dashArray:typeof t<"u"&&t.dataset.shapeStyle==="solid"?"0, 0":"8, 8",fillColor:typeof t<"u"&&t.dataset.shapeColor!==""?t.dataset.shapeColor:this.colors.primary,fillOpacity:0},(a.feature.properties.naam||a.feature.properties.titel)&&a.bindPopup(a.feature.properties.naam||a.feature.properties.titel),typeof a.setStyle=="function"&&(a.setStyle(a._style),a.options.alt=a.feature.properties.naam||a.feature.properties.titel,a.options.title=a.feature.properties.naam||a.feature.properties.titel,a.selected=!1,this.dataHandler(a)),typeof a.setIcon=="function"&&(a.setIcon(a._styles.default),a.options.alt=a.feature.properties.naam||a.feature.properties.titel,a.options.title=a.feature.properties.naam||a.feature.properties.titel,a.selected=!1,this.markerHandler(a,null))}),s};dataHandler=e=>{e.on("click",t=>{this.dataSetState(e,"active"),this.map.flyToBounds(e.getBounds(),{padding:[0,0]})}),e.on("popupclose",t=>this.dataSetState(e,"default"))};dataSetState=(e,t)=>{let s=e._style;switch(t){case"active":case"hover":case"focus":s.fillOpacity=.15;break;default:s.fillOpacity=0;break}e.setStyle(s)};legendHandler=()=>{this.legendNode.querySelectorAll("input")?.forEach(t=>{let s=t.closest(".draad-maps__dataset"),a=s.dataset.datasetName;t.addEventListener("change",r=>{if(t.checked){let p=s.dataset.draadGeojson;if(document.getElementById(s.dataset.draadGeojsonTarget)){let o=JSON.parse(document.getElementById(s.dataset.draadGeojsonTarget).text);this.loadGeoJson(o,a,s);return}else if(p){let o=s.querySelector("input");fetch(p).then(u=>u.json()).then(u=>{this.loadGeoJson(u,a,s)})}}else{if(!this.layers[a])return;this.cluster.removeLayer(this.layers[a]),delete this.layers[a]}})})};searchHandler=()=>{let e=document.getElementById(this.searchInput.getAttribute("list"));this.searchInput.addEventListener("keyup",R(()=>{fetch(`https://nominatim.openstreetmap.org/search?&q=Den+Haag+${this.searchInput.value}&layer=address,manmade,poi&polygon_geojson=1&countrycodes=nl&format=json&addressdetails=1&accept-language=nl-NL&limit=10`).then(t=>t.json()).then(t=>{e.innerHTML="",t.forEach(s=>{let a=document.createElement("option");a.value=s.display_name,e.appendChild(a)})})},750)),this.searchSubmit.addEventListener("click",t=>{t.preventDefault(),this.removeSearchMarker(),fetch(`https://nominatim.openstreetmap.org/search?&q=${encodeURIComponent(this.searchInput.value)}&layer=address,manmade,poi&polygon_geojson=1&countrycodes=nl&format=geojson&addressdetails=1&accept-language=nl-NL&limit=50`).then(s=>s.json()).then(s=>{let a=document.getElementById("draad-search-notice");if(a){if(s.features=s.features.filter(r=>r.properties.address.municipality==="Den Haag"),s.features.length===0){a&&(a.innerHTML="<p>Geen resultaten gevonden</p>");return}a.innerHTML="",this.addSearchMarker(s.features)}}).then(()=>this.sortLocations())})};addSearchMarker=e=>{let t=L.layerGroup();t.addLayer(L.geoJson(e,{style:{color:this.colors.accent,weight:3,fillColor:this.colors.accent,fillOpacity:.3},onEachFeature:(s,a)=>{typeof a.setIcon=="function"?a.setIcon(this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-search.png`})):typeof a.setStyle=="function"&&a.setStyle({color:this.colors.accent,weight:4,dashArray:"0, 0",fillColor:this.colors.accent,fillOpacity:.3})}})),this.map.flyToBounds(L.geoJson(e).getBounds(),{padding:[50,50]}),t.addTo(this.map),this.layers.search=t};removeSearchMarker=()=>{this.layers.search&&(this.map.removeLayer(this.layers.search),delete this.layers.search)};sortLocations=()=>{let e=this.mapNode.closest(".draad-maps__wrapper"),t=e.querySelector(".draad-grid"),s=e.querySelectorAll(".draad-card:not(.draad-card--infowindow)");if(!this.layers.search)return;let a=this.layers.search.getLayers()[0].getBounds().getCenter(),r=[...s].sort((p,o)=>{let u=p.getAttribute("data-draad-center").split("/").map(Number),m=o.getAttribute("data-draad-center").split("/").map(Number),i=this.map.distance(a,u),d=this.map.distance(a,m);return i-d});t.innerHTML="",r.forEach(p=>t.appendChild(p))}};function R(f,e){let t;return(...s)=>{clearTimeout(t),t=setTimeout(()=>{f.apply(this,s)},e)}}})();
//# sourceMappingURL=draad-maps.js.map
