(()=>{var h=class{constructor(e){this.rootEl=e}rootEl=null;_active=!1;firstFocusableElement=null;lastFocusableElement=null;get active(){return this._active}set active(e){typeof e=="boolean"&&(this._active=e,this._active?this.activate():this.deactivate())}activate(){if(!this._active)return;let e=Array.from(this.rootEl.querySelectorAll("a[href], button, textarea, input, select, summary, [tabindex]"));if(e.filter(a=>a.getAttribute("tabindex")!=="-1"),e.length===0)return;let t=e.filter(a=>a.offsetParent!==null);this.firstFocusableElement=t[0],this.lastFocusableElement=t[t.length-1],this.rootEl.addEventListener("keydown",a=>{a.key==="Tab"&&(!a.shiftKey&&document.activeElement===this.lastFocusableElement?(a.preventDefault(),this.firstFocusableElement.focus()):a.shiftKey&&document.activeElement===this.firstFocusableElement&&(a.preventDefault(),this.lastFocusableElement.focus()))})}deactivate(){this.rootEl.removeEventListener("keydown",()=>{}),this.firstFocusableElement=null,this.lastFocusableElement=null}},f=h;var m={},g=new Event("draadMapsLoaded");function y(){m.maps=[],document.querySelectorAll(".draad-maps").forEach(e=>{let t=new p(e);m.maps.push(t),document.dispatchEvent(g)})}document.addEventListener("DOMContentLoaded",y);var p=class{node=null;map=null;center=null;zoom=null;outerWrapper=null;layers={};colors={};constructor(e){if(!e)throw new Error("Draad Maps: No map node provided.");this.mapNode=e,this.outerWrapper=e.closest(".draad-maps__wrapper"),this.map=this.createMap();let t=getComputedStyle(document.documentElement);if(this.colors={primary:t.getPropertyValue("--dk__clr-primary")||"#248641",secondary:t.getPropertyValue("--dk__clr-secondary")||"#7D6200",accent:t.getPropertyValue("--dk__clr-accent")||"#1261A3"},this.cluster=L.markerClusterGroup({showCoverageOnHover:!1,iconCreateFunction:o=>{let i=o.getChildCount(),c=" marker-cluster-large",n=56;return i<10?(c="marker-cluster-small",n=40):i<100&&(c+="marker-cluster-medium",n=48),new L.DivIcon({html:'<div class="marker-cluster"><span>'+i+' <span aria-label="markers"></span></span></div>',className:c,iconSize:new L.Point(n,n)})}}),this.loadFeatures("draad-maps-location"),Array.from(this.outerWrapper.querySelectorAll(".draad-maps__dataset")).map(o=>o.dataset.datasetName)?.forEach(o=>{this.loadFeatures(o)}),this.legendNode=this.outerWrapper.querySelector(".draad-maps__legend"),this.legendNode&&this.legendHandler(),this.outerWrapper.addEventListener("keypress",o=>{o.key==="Enter"&&(c=>{let n=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});c.dispatchEvent(n)})(o.target)}),document.getElementById(e.id+"-gps")){let c=function(n){console.warn(`ERROR(${n.code}): ${n.message}`)},o={enableHighAccuracy:!0,timeout:5e3,maximumAge:0},i=n=>{let l=n.coords,u=L.layerGroup();L.marker([parseFloat(l.latitude),parseFloat(l.longitude)],{icon:this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-gps.png`,iconSize:[48,48],iconAnchor:[24,24]}),riseOnHover:!1,alt:"Your location"}).addTo(u),this.layers.userLocation=u,this.layers.userLocation.addTo(this.cluster)};navigator.geolocation.getCurrentPosition(i,c,o)}this.map.addLayer(this.cluster);let s=this.outerWrapper.querySelector(".draad-search");s&&(this.searchInput=s.querySelector(".draad-search__input"),this.searchSubmit=s.querySelector(".draad-search__submit"),this.searchHandler());let r=this.outerWrapper.querySelector(".draad-maps__instructions");r&&(r.addEventListener("click",()=>r.remove()),r.addEventListener("touchstart",()=>r.remove()))}createMap=()=>{let e=this.mapNode.dataset.draadCenter.split("/");this.center=[parseFloat(e[1]),parseFloat(e[2])],this.zoom=parseInt(e[0]);let t=L.map(this.mapNode.id,{dragging:!L.Browser.mobile,tap:!L.Browser.mobile,scrollWheelZoom:!1}).setView(this.center,this.zoom);return L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(t),t.removeControl(t.zoomControl),L.control.zoom({position:"bottomleft",zoomInText:'<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><g><path d="M10 4.16602V15.8327" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.16602 10H15.8327" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g></svg>',zoomInTitle:"Zoom in",zoomOutText:'<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><g><path d="M4.16602 10H15.8327" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g></svg>',zoomOutTitle:"Zoom out"}).addTo(t),t};loadFeatures(e){let t=this.outerWrapper.querySelectorAll('.draad-card--infowindow[data-dataset-name="'+e+'"]');if(t.length===0)return;let a={type:"FeatureCollection",features:[]};this.layers[e]=L.layerGroup(),t.forEach(s=>{let r=JSON.parse(s.dataset.draadFeature);r.properties.infowindow=s.id,r.properties.datasetName=s.dataset.datasetName,a.features.push(r)}),this.layers[e]=L.geoJSON(a),this.layers[e].getLayers()?.forEach(s=>{let r=document.getElementById(s.feature.properties.infowindow);s._styles={default:typeof r<"u"&&r.dataset.marker!==""?this.getLeafletIcon({iconUrl:r.dataset.marker}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker.png`}),hover:typeof r<"u"&&r.dataset.markerHover!==""?this.getLeafletIcon({iconUrl:r.dataset.markerHover}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-hover.png`}),active:typeof r<"u"&&r.dataset.markerActive!==""?this.getLeafletIcon({iconUrl:r.dataset.markerActive}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-active.png`})},s._style={color:typeof r<"u"&&r.dataset.shapeColor!==""?r.dataset.shapeColor:this.colors.primary,weight:typeof r<"u"&&r.dataset.shapeWidth!==""?r.dataset.shapeWidth:4,dashArray:typeof r<"u"&&r.dataset.shapeStyle==="solid"?"0, 0":"8, 8",fillColor:typeof r<"u"&&r.dataset.shapeColor!==""?r.dataset.shapeColor:this.colors.primary,fillOpacity:0},s.locationTrap=new f(r),typeof s.setIcon=="function"?s.setIcon(s._styles.default):typeof s.setStyle=="function"&&s.setStyle(s._style),s.selected=!1,this.markerHandler(s,r)}),this.layers[e].addTo(this.cluster)}dataSetState=(e,t)=>{let a=e._style;switch(t){case"active":case"hover":case"focus":a.fillOpacity=.15;break;default:a.fillOpacity=0;break}e.setStyle(a)};markerHandler=(e,t=null)=>{let a=t?t.querySelector(".draad-card__close"):null;a&&a.addEventListener("click",s=>{typeof e.setIcon=="function"?e.setIcon(e._styles.default):typeof e.setStyle=="function"&&e.setStyle(e._style),e.selected=!1,e.icon&&e.icon.focus(),t.classList.remove("draad-infowindow--active"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden","")}),e.on("click",s=>{if(t){this.outerWrapper.querySelectorAll(".draad-card--infowindow").forEach(o=>{o.classList.remove("draad-card--active"),o.setAttribute("aria-hidden","true"),o.setAttribute("hidden","")});for(let o in this.layers)this.layers[o].eachLayer(i=>{i.selected===!0&&(typeof i.setStyle=="function"&&this.dataSetState(i,"default"),typeof i.setIcon=="function"&&this.markerSetState(i,"default"),i.locationTrap.active=!1,i.selected=!1)});e.selected===!0?(t.classList.remove("draad-card--active"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden",""),e.locationTrap.active=!1,marker.icon&&marker.icon.focus()):(t.classList.add("draad-card--active"),t.setAttribute("aria-hidden","false"),t.removeAttribute("hidden"),e.locationTrap.active=!0,t.querySelector(".draad-card__close").focus())}else{for(let r in this.layers)this.layers[r].eachLayer(o=>{typeof o.setIcon=="function"?this.markerSetState(o,"default"):typeof o.setStyle=="function"&&o.setStyle(o._style),o.selected=!1,o.locationTrap.active=!1,o.closePopup()});e.openPopup()}typeof e.getLatLng=="function"?this.map.panTo(e.getLatLng()):typeof e.getBounds=="function"&&this.map.flyToBounds(e.getBounds(),{padding:[0,0]})}),e.on("popupclose",s=>{this.markerSetState(e,"default"),e.selected=!1,t&&(t.classList.remove("draad-card--active"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden",""),e.icon&&e.icon.focus())})};markerSetState=(e,t)=>{switch(t){case"active":case"focus":e.setIcon(e._styles.active);break;case"hover":e.setIcon(e._styles.hover);break;default:e.setIcon(e._styles.default);break}};searchHandler=()=>{let e=document.getElementById(this.searchInput.getAttribute("list"));this.searchInput.addEventListener("keyup",v(()=>{fetch(`https://nominatim.openstreetmap.org/search?&q=Den+Haag+${this.searchInput.value}&layer=address,manmade,poi&polygon_geojson=1&countrycodes=nl&format=json&addressdetails=1&accept-language=nl-NL&limit=10`).then(t=>t.json()).then(t=>{e.innerHTML="",t.forEach(a=>{let s=document.createElement("option");s.value=a.display_name,e.appendChild(s)})})},750)),this.searchSubmit.addEventListener("click",t=>{t.preventDefault(),this.removeSearchMarker(),fetch(`https://nominatim.openstreetmap.org/search?&q=${encodeURIComponent(this.searchInput.value)}&layer=address,manmade,poi&polygon_geojson=1&countrycodes=nl&format=geojson&addressdetails=1&accept-language=nl-NL&limit=50`).then(a=>a.json()).then(a=>{let s=document.getElementById("draad-search-notice");if(s){if(a.features=a.features.filter(r=>r.properties.address.municipality==="Den Haag"),a.features.length===0){s&&(s.innerHTML="<p>Geen resultaten gevonden</p>");return}s.innerHTML="",this.addSearchMarker(a.features)}}).then(()=>this.sortLocations())})};addSearchMarker=e=>{let t=L.layerGroup();t.addLayer(L.geoJson(e,{style:{color:this.colors.accent,weight:3,fillColor:this.colors.accent,fillOpacity:.3},onEachFeature:(a,s)=>{typeof s.setIcon=="function"?s.setIcon(this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-search.png`})):typeof s.setStyle=="function"&&s.setStyle({color:this.colors.accent,weight:4,dashArray:"0, 0",fillColor:this.colors.accent,fillOpacity:.3})}})),this.map.flyToBounds(L.geoJson(e).getBounds(),{padding:[50,50]}),t.addTo(this.map),this.layers.search=t};removeSearchMarker=()=>{this.layers.search&&(this.map.removeLayer(this.layers.search),delete this.layers.search)};sortLocations=()=>{let t=this.mapNode.closest(".draad-maps__wrapper").querySelector(".draad-grid"),a=t.querySelectorAll(".draad-card");if(!this.layers.search)return;let s=this.layers.search.getLayers()[0].getBounds().getCenter(),r=[...a].sort((o,i)=>{let c=o.getAttribute("data-draad-center").split("/").map(Number),n=i.getAttribute("data-draad-center").split("/").map(Number),l=this.map.distance(s,c),u=this.map.distance(s,n);return l-u});t.innerHTML="",r.forEach(o=>t.appendChild(o))};legendHandler=()=>{this.legendNode.querySelectorAll("input")?.forEach(t=>{let a=t.closest(".draad-maps__dataset"),s=a.dataset.datasetName;t.addEventListener("change",r=>{if(t.checked){let o=a.dataset.draadGeojson;if(document.getElementById(a.dataset.draadGeojsonTarget)){let i=JSON.parse(document.getElementById(a.dataset.draadGeojsonTarget).text);this.loadFeatures(s);return}else if(o){let i=a.querySelector("input");fetch(o).then(c=>c.json()).then(c=>{this.loadFeatures(s)})}}else{if(!this.layers[s])return;this.cluster.removeLayer(this.layers[s]),delete this.layers[s]}})})};getLeafletIcon=e=>L.icon({iconUrl:"",iconSize:[39.2,51.2],iconAnchor:[19.6,51.2],popupAnchor:[-3,-76],...e})};function v(d,e){let t;return(...a)=>{clearTimeout(t),t=setTimeout(()=>{d.apply(this,a)},e)}}})();
//# sourceMappingURL=draad-maps.js.map
