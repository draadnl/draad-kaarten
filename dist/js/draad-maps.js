(()=>{var M=class{constructor(e){this.rootEl=e}rootEl=null;_active=!1;firstFocusableElement=null;lastFocusableElement=null;get active(){return this._active}set active(e){typeof e=="boolean"&&(this._active=e,this._active?this.activate():this.deactivate())}activate(){if(!this._active)return;let e=Array.from(this.rootEl.querySelectorAll("a[href], button, textarea, input, select, summary, [tabindex]"));if(e.filter(a=>a.getAttribute("tabindex")!=="-1"),e.length===0)return;let t=e.filter(a=>a.offsetParent!==null);this.firstFocusableElement=t[0],this.lastFocusableElement=t[t.length-1],this.rootEl.addEventListener("keydown",a=>{a.key==="Tab"&&(!a.shiftKey&&document.activeElement===this.lastFocusableElement?(a.preventDefault(),this.firstFocusableElement.focus()):a.shiftKey&&document.activeElement===this.firstFocusableElement&&(a.preventDefault(),this.lastFocusableElement.focus()))})}deactivate(){this.rootEl.removeEventListener("keydown",()=>{}),this.firstFocusableElement=null,this.lastFocusableElement=null}},_=M;var C={},U=new Event("draadMapsLoaded");function P(){C.maps=[],document.querySelectorAll(".draad-maps").forEach(e=>{let t=new E(e);C.maps.push(t),document.dispatchEvent(U)})}document.addEventListener("DOMContentLoaded",P);var E=class{node=null;map=null;center=null;zoom=null;outerWrapper=null;layers=[];colors={};constructor(e){if(!e)throw new Error("Draad Maps: No map node provided.");this.mapNode=e,this.outerWrapper=e.closest(".draad-maps__wrapper"),this.map=this.createMap();let t=getComputedStyle(document.documentElement);this.colors={primary:t.getPropertyValue("--dk__clr-primary")||"#248641",secondary:t.getPropertyValue("--dk__clr-secondary")||"#7D6200",accent:t.getPropertyValue("--dk__clr-accent")||"#1261A3"},this.cluster=L.markerClusterGroup({showCoverageOnHover:!1,iconCreateFunction:r=>{let d=r.getChildCount(),h=" marker-cluster-large";return d<10?h="marker-cluster-small":d<100&&(h+="marker-cluster-medium"),new L.DivIcon({html:'<div class="marker-cluster"><span>'+d+' <span aria-label="markers"></span></span></div>',className:h,iconSize:new L.Point(40,40)})}});let a=this.outerWrapper.querySelectorAll(".draad-card--infowindow"),s=L.layerGroup(),o=0;a?.forEach(r=>{let d=r.offsetHeight;d>o&&(o=d),this.addMarker(r).addTo(s)}),this.layers.locations=s,this.layers.locations.addTo(this.cluster);let l=parseInt(getComputedStyle(document.documentElement).fontSize);if(e.style.minHeight=Math.round(o/l)+3+"rem",this.outerWrapper.addEventListener("keypress",r=>{r.key==="Enter"&&(h=>{let m=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});h.dispatchEvent(m)})(r.target)}),document.getElementById(e.id+"-gps")){let h=function(m){console.warn(`ERROR(${m.code}): ${m.message}`)},r={enableHighAccuracy:!0,timeout:5e3,maximumAge:0},d=m=>{let f=m.coords,y=L.layerGroup();L.marker([parseFloat(f.latitude),parseFloat(f.longitude)],{icon:this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-gps.png`,iconSize:[48,48],iconAnchor:[24,24]}),riseOnHover:!1,alt:"Your location"}).addTo(y),this.layers.userLocation=y,this.layers.userLocation.addTo(this.cluster)};navigator.geolocation.getCurrentPosition(d,h,r)}let i=document.querySelectorAll(".draad-maps__dataset");i.length&&(i.forEach(r=>{let d=r.dataset.draadGeojson,h=r.dataset.datasetName;if(document.getElementById(r.dataset.draadGeojsonTarget)){let m=JSON.parse(document.getElementById(r.dataset.draadGeojsonTarget).text),f=m;f=this.jsonToGeoJSON(m);let y=this.addData(f,r);this.layers[h]=y,this.layers[h].addTo(this.cluster)}else if(d){let m=r.querySelector("input");fetch(d).then(f=>f.json()).then(f=>{let y=f;y=this.jsonToGeoJSON(f);let v=this.addData(y,r);this.layers[h]=v,this.layers[h].addTo(this.cluster)})}}),this.legendNode=this.outerWrapper.querySelector(".draad-maps__legend"),this.legendNode&&this.legendHandler()),this.map.addLayer(this.cluster);let p=this.outerWrapper.querySelector(".draad-search");p&&(this.searchInput=p.querySelector(".draad-search__input"),this.searchSubmit=p.querySelector(".draad-search__submit"),this.searchHandler());let u=this.outerWrapper.querySelector(".draad-maps__instructions");u&&(u.addEventListener("click",()=>u.remove()),u.addEventListener("touchstart",()=>u.remove()))}getLeafletIcon=e=>L.icon({iconUrl:"",iconSize:[39.2,51.2],iconAnchor:[19.6,51.2],popupAnchor:[-3,-76],...e});isRdCoordinates(e,t){return typeof e!="number"||typeof t!="number"?(console.log(e,t),console.error("Draad_Map.isRdCoordinates(): coordinates not valid"),!1):e>0&&e<3e5&&t>3e5&&t<62e4}rdToWgs84=(e,t)=>{if(typeof e!="number"||typeof t!="number")return console.error("Draad_Map.rdToWgs84(): coordinates not valid"),!1;e<1e3&&(e*=1e3),t<1e3&&(t*=1e3);let a=155e3,s=463e3,o=52.156160556,l=5.387638889,i=3236.0331637,p=5261.3028966,u=-32.5915821,r=105.9780241,d=-.2472814,h=2.4576469,m=-.8501341,f=-.8192156,y=-.0655238,v=-.0560092,T=-.0171137,I=.0560089,A=.0052771,O=-.0025614,N=-3859e-7,j=.001277,H=3314e-7,D=2574e-7,F=371e-7,q=-973e-7,G=143e-7,x=293e-7,J=-9e-6,W=291e-7,n=(e-a)*Math.pow(10,-5),c=(t-s)*Math.pow(10,-5),b=i*c+u*Math.pow(n,2)+d*Math.pow(c,2)+m*Math.pow(n,2)*c+y*Math.pow(c,3);b+=A*Math.pow(n,4)+T*Math.pow(n,2)*Math.pow(c,2)+F*Math.pow(c,4)+H*Math.pow(n,4)*c,b+=N*Math.pow(n,2)*Math.pow(c,3)+G*Math.pow(n,4)*Math.pow(c,2)+J*Math.pow(n,2)*Math.pow(c,4);let w=o+b/3600,S=p*n+r*n*c+f*Math.pow(n,3)+h*n*Math.pow(c,2)+v*Math.pow(n,3)*c;S+=I*n*Math.pow(c,3)+D*Math.pow(n,5)+O*Math.pow(n,3)*Math.pow(c,2)+j*n*Math.pow(c,4),S+=x*Math.pow(n,5)*c+q*Math.pow(n,3)*Math.pow(c,3)+W*n*Math.pow(c,5);let k=l+S/3600,z=w+(-96.862-11.714*(w-52)-.125*(k-5))/1e5,B=k+(-37.902+.329*(w-52)-14.667*(k-5))/1e5;return{lat:z,lon:B}};parseGeometry=e=>{let t;switch(e.type){case"Point":let a=e.coordinates[0],s=e.coordinates[1];if(t=[a,s],this.isRdCoordinates(a,s)){let o=this.rdToWgs84(a,s);t=[o.lat,o.lon]}return{type:"Point",coordinates:t};case"MultiPoint":return t=e.coordinates.map(o=>{if(this.isRdCoordinates(o[0],o[1])){let l=this.rdToWgs84(o[0],o[1]);t=[l.lon,l.lat]}return t}),{type:"Point",coordinates:t[0]};break;default:console.log("Not a valid geometry type",e);break}};jsonToGeoJSON=e=>{let a={type:"FeatureCollection",features:(typeof e.result=="object"?e.result.records:e.features).map(s=>({type:"Feature",geometry:s.wkb_geometry||this.parseGeometry(s.geometry),properties:{...s.properties}}))};return console.log(a),a};createMap=()=>{let e=this.mapNode.dataset.draadCenter.split("/");this.center=[parseFloat(e[1]),parseFloat(e[2])],this.zoom=parseInt(e[0]);let t=L.map(this.mapNode.id,{dragging:!L.Browser.mobile,tap:!L.Browser.mobile,scrollWheelZoom:!1}).setView(this.center,this.zoom);return L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:16,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(t),t.removeControl(t.zoomControl),L.control.zoom({position:"bottomleft",zoomInText:'<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><g><path d="M10 4.16602V15.8327" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.16602 10H15.8327" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g></svg>',zoomInTitle:"Zoom in",zoomOutText:'<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><g><path d="M4.16602 10H15.8327" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g></svg>',zoomOutTitle:"Zoom out"}).addTo(t),t};addMarker=e=>{let t=e.dataset.draadCenter.split("/").map(parseFloat),a=L.marker(t,{riseOnHover:!0,alt:e.querySelector(".draad-card__title")?.textContent});return a._styles={default:e.dataset.marker!==""?this.getLeafletIcon({iconUrl:e.dataset.marker}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker.png`}),hover:e.dataset.markerHover!==""?this.getLeafletIcon({iconUrl:e.dataset.markerHover}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-hover.png`}),active:e.dataset.markerActive!==""?this.getLeafletIcon({iconUrl:e.dataset.markerActive}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-active.png`})},a.setIcon(a._styles.default),a.selected=!1,a.locationTrap=new _(e),this.markerHandler(a,e),a};markerHandler=(e,t=null)=>{let a=this,s=t?t.querySelector(".draad-card__close"):null;s&&s.addEventListener("click",o=>{e.locationTrap.active=!1,this.markerSetState(e,"default"),e.selected=!1,e.icon&&e.icon.focus(),t.classList.remove("draad-infowindow--active"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden","")}),e.on("click",o=>{t&&t.querySelector(".draad-card__content")?.textContent?(t.closest(".draad-maps__wrapper").querySelectorAll(".draad-card--infowindow").forEach(i=>{i.classList.remove("draad-card--active"),i.setAttribute("aria-hidden","true"),i.setAttribute("hidden","")}),this.layers.locations.eachLayer(i=>{i.selected===!0&&(this.markerSetState(i,"default"),i.selected=!1)}),e.selected===!0?(e.locationTrap.active=!1,t.classList.remove("draad-card--active"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden",""),e.icon&&e.icon.focus()):(t.classList.add("draad-card--active"),t.setAttribute("aria-hidden","false"),t.removeAttribute("hidden"),e.locationTrap.active=!0,t.querySelector(".draad-card__close").focus())):e.openPopup(),this.markerSetState(e,e.selected?"default":"active"),e.selected=!e.selected}),e.on("popupclose",o=>{this.markerSetState(e,"default"),e.selected=!1,t&&(e.locationTrap.active=!1,t.classList.remove("draad-card--active"),t.setAttribute("aria-hidden","true"),t.setAttribute("hidden",""),e.icon&&e.icon.focus())})};markerSetState=(e,t)=>{switch(t){case"active":case"focus":e.setIcon(e._styles.active);break;case"hover":e.setIcon(e._styles.hover);break;default:e.setIcon(e._styles.default);break}};addData=(e,t)=>{let a=L.geoJSON(e);return a.getLayers()?.forEach(s=>{s._styles={default:typeof t<"u"&&t.dataset.marker!==""?this.getLeafletIcon({iconUrl:t.dataset.marker}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker.png`}),hover:typeof t<"u"&&t.dataset.markerHover!==""?this.getLeafletIcon({iconUrl:t.dataset.markerHover}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-hover.png`}),active:typeof t<"u"&&t.dataset.markerActive!==""?this.getLeafletIcon({iconUrl:t.dataset.markerActive}):this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-active.png`})},s._style={color:typeof t<"u"&&t.dataset.shapeColor!==""?t.dataset.shapeColor:this.colors.primary,weight:typeof t<"u"&&t.dataset.shapeWidth!==""?t.dataset.shapeWidth:4,dashArray:typeof t<"u"&&t.dataset.shapeStyle==="solid"?"0, 0":"8, 8",fillColor:typeof t<"u"&&t.dataset.shapeColor!==""?t.dataset.shapeColor:this.colors.primary,fillOpacity:0},s.feature.properties.titel&&s.bindPopup(s.feature.properties.titel),typeof s.setStyle=="function"&&(s.setStyle(s._style),s.options.alt=s.feature.properties?.name,s.options.title=s.feature.properties?.titel,s.selected=!1,this.dataHandler(s)),typeof s.setIcon=="function"&&(s.setIcon(s._styles.default),s.options.alt=s.feature.properties?.name,s.options.title=s.feature.properties?.titel,s.selected=!1,this.markerHandler(s,null))}),a};dataHandler=e=>{let t=this;e.on("click",a=>{this.dataSetState(e,"active"),this.map.flyToBounds(e.getBounds(),{padding:[0,0]})}),e.on("popupclose",a=>this.dataSetState(e,"default"))};dataSetState=(e,t)=>{switch(t){case"active":let a=e._style;a.fillOpacity=.15,e.setStyle(a);break;case"hover":let s=e._style;s.fillOpacity=.15,e.setStyle(s);break;case"focus":let o=e._style;o.fillOpacity=.15,e.setStyle(o);break;default:let l=e._style;l.fillOpacity=0,e.setStyle(l);break}};legendHandler=()=>{this.legendNode.querySelectorAll("input")?.forEach(t=>{let a=t.closest(".draad-maps__dataset"),s=a.dataset.datasetName;t.addEventListener("change",o=>{if(t.checked){let l=a.dataset.draadGeojson;if(document.getElementById(a.dataset.draadGeojsonTarget)){let i=JSON.parse(document.getElementById(a.dataset.draadGeojsonTarget).text),p=null;typeof i.type>"u"||i.type!=="FeatureCollection"?p=this.jsonToGeoJSON(i):p=this.jsonToGeoJSON(i);let u=this.addData(p,a);this.layers[s]=u,this.layers[s].addTo(this.cluster)}else if(l){let i=a.querySelector("input");fetch(l).then(p=>p.json()).then(p=>{let u=p;u=this.jsonToGeoJSON(p);let r=a.dataset.draadMarker,d=a.dataset.draadMarkerActive,h=this.addData(u,a);this.layers[s]=h,this.layers[s].addTo(this.cluster)})}}else{if(!this.layers[s])return;this.cluster.removeLayer(this.layers[s]),delete this.layers[s]}})})};searchHandler=()=>{let e=document.getElementById(this.searchInput.getAttribute("list"));this.searchInput.addEventListener("keyup",$(()=>{fetch(`https://nominatim.openstreetmap.org/search?&q=Den+Haag+${this.searchInput.value}&layer=address,manmade,poi&polygon_geojson=1&countrycodes=nl&format=json&addressdetails=1&limit=10`).then(t=>t.json()).then(t=>{e.innerHTML="",t.forEach(a=>{let s=document.createElement("option");s.value=a.display_name,e.appendChild(s)})})},750)),this.searchSubmit.addEventListener("click",t=>{t.preventDefault(),this.removeSearchMarker(),fetch(`https://nominatim.openstreetmap.org/search?&q=Den+Haag+${this.searchInput.value}&layer=address,manmade,poi&polygon_geojson=1&countrycodes=nl&format=geojson&addressdetails=1&limit=1`).then(a=>a.json()).then(a=>{a.features.length!==0&&this.addSearchMarker(a)}).then(()=>this.sortLocations())})};addSearchMarker=e=>{let t=L.layerGroup();t.addLayer(L.geoJson(e,{style:{color:this.colors.accent,weight:3,fillColor:this.colors.accent,fillOpacity:.3},onEachFeature:(a,s)=>{typeof s.setIcon=="function"?s.setIcon(this.getLeafletIcon({iconUrl:`${draadMapsConfig.pluginDir}/dist/images/marker-search.png`})):typeof s.setStyle=="function"&&s.setStyle({color:this.colors.accent,weight:4,dashArray:"0, 0",fillColor:this.colors.accent,fillOpacity:.3})}})),this.map.flyToBounds(L.geoJson(e).getBounds(),{padding:[50,50]}),t.addTo(this.map),this.layers.search=t};removeSearchMarker=()=>{this.layers.search&&(this.map.removeLayer(this.layers.search),delete this.layers.search)};sortLocations=()=>{let e=this.mapNode.closest(".draad-maps__wrapper"),t=e.querySelector(".draad-grid"),a=e.querySelectorAll(".draad-card:not(.draad-card--infowindow)");if(!this.layers.search)return;let s=this.layers.search.getLayers()[0].getBounds().getCenter(),o=[...a].sort((l,i)=>{let p=l.getAttribute("data-draad-center").split("/").map(Number),u=i.getAttribute("data-draad-center").split("/").map(Number),r=this.map.distance(s,p),d=this.map.distance(s,u);return r-d});t.innerHTML="",o.forEach(l=>t.appendChild(l))}};function $(g,e){let t;return(...a)=>{clearTimeout(t),t=setTimeout(()=>{g.apply(this,a)},e)}}})();
//# sourceMappingURL=draad-maps.js.map
